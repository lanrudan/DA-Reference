---
title: "ABTest"
---

## 概览

  本章介绍AB测试。**AB测试**（也称为随机对照试验 - RCT, Randomized Controlled Trial）是一种用于因果推断的实验设计方法。其核心在于通过**随机分配**将受试单元（用户、会话、页面访问等）分配到不同的处理组（通常是A：对照组/Baseline，B：新方案组），在控制其他变量（通过随机化）的前提下，比较不同处理对特定目标指标的影响，从而决定哪个更优。

  本章参考了\@knuth84

## 理论基础

### 因果推断的基石：潜在结果s框架与随机化

1.  **潜在结果框架（Neyman-Rubin Causal Model）：**

    -   **定义**：对于每个实验单元$i$（用户、会话等），定义两个潜在结果：

        -   $Y_i(1)$：单元$i$接受处理$B$（干预）时的结果

        -   $Y_i(0)$：单元$i$接受处理$A$（对照）时的结果

    -   **个体处理效应：**$\text{ITE} = \tau_i = Y_i(1) - Y_i(0)$

    -   **根本问题**：对于任何单元$i$，我们只能观察到$Y_i(1)$或$Y_i(0)$，永远无法同时观测两者，观察到的结果$Y_i^{obs} = Z_i * Y_i(1) + (1 - Z_i) * Y_i(0)$，其中$Z_i$是指示变量，$Z_i=1$ 表示分配到$B$组，$Z_i=0$ 表示分配到$A$组)。

    -   **目标**：估计**平均处理效应**$\text{ATE} = \tau = E[\tau_i] = E[Y_i(1)-Y_i(0)]=E[Y(1)]-E[Y(0)]$

2.  **随机化**

-   **关键假设（Ignorability/Unconfoundedness）**：通过**完全随机分配**，我们确保处理分配$Z_i$独立于潜在结果，即$Y_i(1),Y_i(0) \perp Z_i$，这意味着$E[Y_i(1) | Z_i=1] = E[Y_i(1) | Z_i=0] = E[Y_i(1)]$（同理于$Y_i(0)$）。

-   **无偏估计量：**基于观测数据，ATE 的一个简单无偏估计量是**组间均值差**$$\hat{τ}_{DiM} = \hat{E}[Y^{obs} | Z=1] - \hat{E}[Y^{obs} | Z=0] = \bar{Y}_B - \bar{Y}_A$$

    -   **证明无偏性**： $$E[\hat{τ}_{DiM}] = E[\bar{Y}_B - \bar{Y}_A] = E[\bar{Y}_B] - E[\bar{Y}_A] = E[Y(1) | Z=1] - E[Y(0) | Z=0]$$（根据观测数据定义）

        由于随机化（$Y_i(1),Y_i(0) \perp Z_i$），有$E[Y(1) | Z=1] = E[Y(1)]$且$E[Y(0) | Z=0] = E[Y(0)]$ 因此$E[\hat{τ}_{DiM}] = E[Y(1)] - E[Y(0)] = ATE$

-   **协变量平衡 (Covariate Balance):** 随机化也确保所有观测到的$X$ 和未观测到的 $U$ 混杂因素（Confounders）在组间的分布是相同的（渐近意义上）： $F(X | Z=1) = F(X | Z=0)$和$F(U | Z=1) = F(U | Z=0)$

这是实现$Y(1),Y(0) \perp Z$的关键保障。AA测试检查的就是观测到的 X是否平衡。

### 假说检验

1.  **核心框架**

-   原假设$H_0$：$ATE = 0$或等价的$\mu_A = \mu_B$（总体均值相等）或$p_A = p_B$（总体比例相等）。

-   备择假设$H_1$：$ATE \neq 0$（双尾）或$ATE>0$或$ATE<0$（单尾）。

-   检验统计量$T$：构造一个统计量，其分布在$H_0$成立时已知（或渐进已知）。

-   $P-value$：$p=P\left(|T| \geq \left|t_{obs}\right| \middle| H_0\right)$，即$H_0$成立时，观察到当前统计量$t_{obs}$甚至于更极端值的概率。

-   决策：若$p<\alpha$，$\alpha$为我们预设的显著性水平，则拒绝$H_0$。

2.  **连续性指标：双样本**$t$**检验**

-   假设：

    -   独立性Independent Samples

    -   正态性Normality：每组数据近似正态分布（或样本量足够大，依赖CLT）

    -   方差齐性Homoscedasticity：$\sigma_A^2 = \sigma_B^2 = \sigma^2$

-   检验统计量：

$$t = \frac{(\bar{Y}_B - \bar{Y}_A) - 0}{s_p \sqrt{\frac{1}{n_A} + \frac{1}{n_B}}}$$ 其中$s_p² = \frac{(n_A - 1)s_A² + (n_B - 1)s_B²}{n_A + n_B - 2}$是合并方差估计量 (Pooled Variance Estimator)，$s_A^2$，$s_B^2$是样本方差，$n_A$，$n_B$是样本量。

-   分布：在$H_0$和假设成立的条件下，$t \sim t_{df}$，自由度$df = n_A+n_B-2$

-   方差不齐 (Welch's t-test):若方差不齐，使用调整后的统计量和自由度， $$t = \frac{\bar{Y}_B - \bar{Y}_A}{\sqrt{\frac{s_A²}{n_A} + \frac{s_B²}{n_B}}}$$，自由度为$df ≈ \frac{(\frac{s_A²}{n_A} + \frac{s_B²}{n_B})²}{\frac{(s_A²/n_A)²}{n_A - 1} + \frac{(s_B²/n_B)²}{n_B - 1}}$

3.  **比例型指标：双样本比例检验（**$Z$**检验）**

-   假设：

    -   独立性

    -   大样本：$(n_A p_A > 5, n_A (1-p_A) > 5, n_B p_B > 5, n_B (1-p_B) > 5)$，确保二项分布近似正态。

-   检验统计量（基于合并比例）： $$Z = \frac{\hat{p}_B - \hat{p}_A}{\sqrt{\hat{p}(1-\hat{p}) (\frac{1}{n_A} + \frac{1}{n_B})}}$$ 其中$\hat{p} = \frac{X_A + X_B}{n_A + n_B}$，$X_A$，$X_B$是成功的次数，是$H_0(p_A =p_B = p)$下$p$的合并估计量。

-   分布：在$H_0$和假设成立的条件下，$Z\sim N(0, 1)$（渐近）。

-   基于独立方差（更常用且推荐）：

$$Z = \frac{\hat{p}_B - \hat{p}_A}{\sqrt{\hat{p}(1-\hat{p}) (\frac{1}{n_A} + \frac{1}{n_B})}}$$，这个版本不依赖与$H_0$下$p_A=p_B$的假设，在构建置信区间时更加自然，检验功效稍低但是更稳健。渐近分布同样是$N(0, 1)$。

4.  **置信区间（CI）**

-   概念：基于样本数据构造一个区间$(L, U)$，使得我们要估计的参数$\theta$（我们这里是$ATE$）落在这个区间的概率是$1-\alpha$，即$P(L\leq \theta \leq U) = 1-\alpha$。频率学派的解释是，重复多次试验，每次构造一个CI，那么大约$1-\alpha$的CI会包含真实的$\theta$。以下均以双尾检验为例。

-   连续性指标（差异）：$$(\bar{Y}_B - \bar{Y}_A) \pm t_{df, 1-\alpha/2} \times SE(\bar{Y}_B - \bar{Y}_A)$$
其中$SE(\bar{Y}_B - \bar{Y}_A) = \sqrt{\frac{s_A²}{n_A} + \frac{s_B²}{n_B}} $（Welch)）或$ s_p \sqrt{\frac{1}{n_A} + \frac{1}{n_B}}$（Pooled）。

-   比例型指标（差异）：$$(\hat{p}_B - \hat{p}_A) \pm Z_{1-\alpha/2} \times \sqrt{\frac{\hat{p}_A(1-\hat{p}_A)}{n_A} + \frac{\hat{p}_B(1-\hat{p}_B)}{n_B}}$$

-   解读：如果95%CI不包含0，则双尾验证在$\alpha $显著性水平下显著。CI宽度反映了估计的精确度。

### 统计功效与样本量计算

1.  定义与公式

### 方差估计的挑战（用户级随机化）

-   问题核心：

### 多重检验问题（Multiple Testing Problem）

### 进阶统计视角
