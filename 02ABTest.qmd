---
title: "ABTest"
---

## 概览

  本章介绍AB测试。**AB测试**（也称为随机对照试验 - RCT, Randomized Controlled Trial）是一种用于因果推断的实验设计方法。其核心在于通过**随机分配**将受试单元（用户、会话、页面访问等）分配到不同的处理组（通常是A：对照组/Baseline，B：新方案组），在控制其他变量（通过随机化）的前提下，比较不同处理对特定目标指标的影响，从而决定哪个更优。

  本章参考了\@knuth84

## 理论基础

### 因果推断的基石：潜在结果框架与随机化

1.  **潜在结果框架（Neyman-Rubin Causal Model）：**

    -   **定义**：对于每个实验单元$i$（用户、会话等），定义两个潜在结果：

        -   $Y_i(1)$：单元$i$接受处理$B$（干预）时的结果

        -   $Y_i(0)$：单元$i$接受处理$A$（对照）时的结果

    -   **个体处理效应：**$\text{ITE} = \tau_i = Y_i(1) - Y_i(0)$

    -   **根本问题**：对于任何单元$i$，我们只能观察到$Y_i(1)$或$Y_i(0)$，永远无法同时观测两者，观察到的结果$Y_i^{obs} = Z_i * Y_i(1) + (1 - Z_i) * Y_i(0)$，其中$Z_i$是指示变量，$Z_i=1$ 表示分配到$B$组，$Z_i=0$ 表示分配到$A$组)。

    -   **目标**：估计**平均处理效应**$\text{ATE} = \tau = E[\tau_i] = E[Y_i(1)-Y_i(0)]=E[Y(1)]-E[Y(0)]$

2.  **随机化**

-   **关键假设（Ignorability/Unconfoundedness）**：通过**完全随机分配**，我们确保处理分配$Z_i$独立于潜在结果，即$Y_i(1),Y_i(0) \perp Z_i$，这意味着$E[Y_i(1) | Z_i=1] = E[Y_i(1) | Z_i=0] = E[Y_i(1)]$（同理于$Y_i(0)$）。

-   **无偏估计量：**基于观测数据，ATE 的一个简单无偏估计量是**组间均值差**$$\hat{τ}_{DiM} = \hat{E}[Y^{obs} | Z=1] - \hat{E}[Y^{obs} | Z=0] = \bar{Y}_B - \bar{Y}_A$$

    -   **证明无偏性**： $$E[\hat{τ}_{DiM}] = E[\bar{Y}_B - \bar{Y}_A] = E[\bar{Y}_B] - E[\bar{Y}_A] = E[Y(1) | Z=1] - E[Y(0) | Z=0]$$（根据观测数据定义）

        由于随机化（$Y_i(1),Y_i(0) \perp Z_i$），有$E[Y(1) | Z=1] = E[Y(1)]$且$E[Y(0) | Z=0] = E[Y(0)]$ 因此$E[\hat{τ}_{DiM}] = E[Y(1)] - E[Y(0)] = ATE$

-   **协变量平衡 (Covariate Balance):** 随机化也确保所有观测到的$X$ 和未观测到的 $U$ 混杂因素（Confounders）在组间的分布是相同的（渐近意义上）： $F(X | Z=1) = F(X | Z=0)$和$F(U | Z=1) = F(U | Z=0)$

这是实现$Y(1),Y(0) \perp Z$的关键保障。AA测试检查的就是观测到的 X是否平衡。

### 假说检验

1.  **核心框架**

-   原假设$H_0$：$ATE = 0$或等价的$\mu_A = \mu_B$（总体均值相等）或$p_A = p_B$（总体比例相等）。

-   备择假设$H_1$：$ATE \neq 0$（双尾）或$ATE>0$或$ATE<0$（单尾）。

-   检验统计量$T$：构造一个统计量，其分布在$H_0$成立时已知（或渐进已知）。

-   $P-value$：$p=P\left(|T| \geq \left|t_{obs}\right| \middle| H_0\right)$，即$H_0$成立时，观察到当前统计量$t_{obs}$甚至于更极端值的概率。

-   决策：若$p<\alpha$，$\alpha$为我们预设的显著性水平，则拒绝$H_0$。

2.  **连续性指标：双样本**$t$**检验**

  例如平均订单金额、会话时长。

-   假设：

    -   独立性Independent Samples

    -   正态性Normality：每组数据近似正态分布（或样本量足够大，依赖CLT）

    -   方差齐性Homoscedasticity：$\sigma_A^2 = \sigma_B^2 = \sigma^2$

-   检验统计量：

$$t = \frac{(\bar{Y}_B - \bar{Y}_A) - 0}{s_p \sqrt{\frac{1}{n_A} + \frac{1}{n_B}}}$$ 其中$s_p² = \frac{(n_A - 1)s_A² + (n_B - 1)s_B²}{n_A + n_B - 2}$是合并方差估计量 (Pooled Variance Estimator)，$s_A^2$，$s_B^2$是样本方差，$n_A$，$n_B$是样本量。

-   分布：在$H_0$和假设成立的条件下，$t \sim t_{df}$，自由度$df = n_A+n_B-2$

-   方差不齐 (Welch's t-test):若方差不齐，使用调整后的统计量和自由度， $$t = \frac{\bar{Y}_B - \bar{Y}_A}{\sqrt{\frac{s_A²}{n_A} + \frac{s_B²}{n_B}}}$$，自由度为$df ≈ \frac{(\frac{s_A²}{n_A} + \frac{s_B²}{n_B})²}{\frac{(s_A²/n_A)²}{n_A - 1} + \frac{(s_B²/n_B)²}{n_B - 1}}$

3.  **比例型指标：双样本比例检验（**$Z$**检验）**

  例如点击率、转化率。

-   假设：

    -   独立性

    -   大样本：$(n_A p_A > 5, n_A (1-p_A) > 5, n_B p_B > 5, n_B (1-p_B) > 5)$，确保二项分布近似正态。

-   检验统计量（基于合并比例）： $$Z = \frac{\hat{p}_B - \hat{p}_A}{\sqrt{\hat{p}(1-\hat{p}) (\frac{1}{n_A} + \frac{1}{n_B})}}$$ 其中$\hat{p} = \frac{X_A + X_B}{n_A + n_B}$，$X_A$，$X_B$是成功的次数，是$H_0(p_A =p_B = p)$下$p$的合并估计量。

-   分布：在$H_0$和假设成立的条件下，$Z\sim N(0, 1)$（渐近）。

-   基于独立方差（更常用且推荐）：

$$Z = \frac{\hat{p}_B - \hat{p}_A}{\sqrt{\hat{p}(1-\hat{p}) (\frac{1}{n_A} + \frac{1}{n_B})}}$$，这个版本不依赖与$H_0$下$p_A=p_B$的假设，在构建置信区间时更加自然，检验功效稍低但是更稳健。渐近分布同样是$N(0, 1)$。

4.  **计数型指标**   例如人均点击次数。常假设服从泊松分布，使用基于泊松回归或负二项回归的检验（处理过离散问题）。

5.  **置信区间（CI）**

-   概念：基于样本数据构造一个区间$(L, U)$，使得我们要估计的参数$\theta$（我们这里是$ATE$）落在这个区间的概率是$1-\alpha$，即$P(L\leq \theta \leq U) = 1-\alpha$。频率学派的解释是，重复多次试验，每次构造一个CI，那么大约$1-\alpha$的CI会包含真实的$\theta$。以下均以双尾检验为例。

-   连续性指标（差异）：$$(\bar{Y}_B - \bar{Y}_A) \pm t_{df, 1-\alpha/2} \times SE(\bar{Y}_B - \bar{Y}_A)$$ 其中\$SE(\bar{Y}\_B - \bar{Y}\_A) = \sqrt{\frac{s_A²}{n_A} + \frac{s_B²}{n_B}} $（Welch)）或$ s_p \sqrt{\frac{1}{n_A} + \frac{1}{n_B}}\$（Pooled）。

-   比例型指标（差异）：$$(\hat{p}_B - \hat{p}_A) \pm Z_{1-\alpha/2} \times \sqrt{\frac{\hat{p}_A(1-\hat{p}_A)}{n_A} + \frac{\hat{p}_B(1-\hat{p}_B)}{n_B}}$$

-   解读：如果95%CI不包含0，则双尾验证在\$\alpha \$显著性水平下显著。CI宽度反映了估计的精确度。

### 统计功效与样本量计算

1.  定义与公式

-   I类错误（$\alpha$）：$H_0$为真时，错误地拒绝$H_0$。也就是说宣称有差异实际没有。

-   II类错误（$\beta$）：$H_1$为真时，没有拒绝$H_0$。也就是说实际上有差异但是没有检测到。

-   功效（Power）$1-\beta$：$P(\text{Reject } H₀ | H₁ \text{ is true})$。即当真实效应$\delta = |ATE|$（或$|\mu_B -\mu_A|$，$|p_B - p_A|$）存在且等于最小期望检测效应（MDE）时，正确拒绝$H_0$的概率。**换句话说，就是当处理B确实比A好（**$H_1$为真）时，正确拒绝$H_0$的概率$1-\beta$。

-   影响功效的关键因素（以双样本$t$检验为例）：

    -   效应量（$\delta$）:期望检测到的最小有意义的差异$\delta = \frac{|\mu_B - \mu_A|}{\sigma}$，这是标准化效应量，Cohen'sd。$\delta$越大，功效越高，$\delta$越小，检测所需要的样本量越大。

    -   样本量（$n = n_A= n_B$）:$n$越大，功效越高，功效$\propto \sqrt{n}$

    -   显著性水平（$\alpha$）：犯I类错误（假阳性）的概率。$\alpha$越大，即允许更多假阳性，功效越高。$\alpha$越小，所需要样本量越大。

    -   方差（$\sigma^2$）：$\sigma^2$越大，功效越低。指标本身的变异性越大，检测相同效应量所需的样本量越大（对于连续型指标）。

    -   基准比率（p_A）：对于比例指标，基准转化率影响方差（p(1-p)），在p=0.5时最大。

-   样本量计算公式（双样本$t$检验，双尾，等样本量）：

$$n \approx \frac{2 (Z_{1-\alpha/2} + Z_{1-\beta})^2 \sigma^2}{\delta^2}$$

其中\$ Z\_{1-\alpha/2}, Z\_{1-\beta}$是标准正态分布的分位数，$\delta$是未标准化的效应量（$\|\mu\_B-\mu\_A\|$）。这个公式推导基于$H_0$下的统计量$\sim N(0, 1)$，$H_1$下的统计量$\sim N(\frac{\delta}{\sigma \sqrt{2/n}}, 1)$，令两个分布的拒绝域边界相交即可解出$n\$。

-   比例型指标（双样本比例检验，双尾，等样本量）：

$$n \approx \frac{ (Z_{1-\alpha/2} \sqrt{2\bar{p}(1-\bar{p})} + Z_{1-\beta} \sqrt{p_A(1-p_A) + p_B(1-p_B)} )² }{\delta²}$$ 其中$\delta = |p_B-p_A|,\bar{p} = \frac{p_A+p_B}{2}$，推导类似，考虑$H_0$下方差基于$\bar{p}$，$H1$下方差基于真实的$p_A$和$p_B$。

### 方差估计的挑战（用户级随机化）

-   问题核心：在用户级随机化的AB测试中，分析单元（如页面浏览PV，点击Click）与随机化单元（用户User）不一致。同一个用户的不同事件/行为不独立。

-   后果：传统的方差估计公式（如$\frac{s^2}{n}$）会严重低估真实方差，导致：

    -   CI过窄

    -   $p-value$过小，I类错误率（假阳性率）膨胀

-   数学解释：

    -   假设有$m$个用户$i = 1...m$，用户$i$贡献$n_i$个观测值（如$PV$），总观测值$N = \sum_i n_i$

    -   核心指标$Y$在用户$i$上的平均为$\bar{Y}_i$

    -   组件差异估计量$\hat{\tau} = \bar{Y}_B - \bar{Y}_A$

    -   其真实方差为：$Var(\hat{τ}) = Var(\frac{1}{m_B} \sum_{i \in B} \bar{Y}_i - \frac{1}{m_A} \sum_{j \in A} \bar{Y}_j)$，由于用户间是独立的，$Var(\hat{τ}) = \frac{Var(\bar{Y}_i | B)}{m_B} + \frac{Var(\bar{Y}_j | A)}{m_A}$

    -   而传统方差估计（假设观测独立）为：$\widehat{Var}_{naive}(\hat{τ}) \approx \frac{s_B²}{N_B} + \frac{s_A²}{N_A}$，其中$N_B = \sum_{i \in B} n_i$（B组总观测数），$s_B^2$是基于所有B组观测值计算的方差

    -   $\widehat{Var}_{naive}$会系统性小于$Var(\hat{\tau})$，因为忽略了用户的内相关性。低估的程度取决于用户内相关性的强度和用户行为次数$n_i$的变异度。

-   解决方案：

    -   $Delta$ $Method$：推倒$\hat{\tau}$方差的理论表达式并进行估计。适用于特定指标类型（如人均指标）。

    -   聚类标准误（Cluster-Robust Standard Errors - CRSE）：将方差估计建立在随机化单元（用户）的层面。

        -   将每一个用户视为一个“聚类”

        -   计算每个用户$i$对$\hat{\tau}$的“得分”（Influence Function）或残差贡献$e_i$

        -   聚类标准误为： $\widehat{Var}_{CR}(\hat{τ}) = \frac{m}{m-1} \frac{m}{m_A m_B} \sum_{i=1}^m (\tilde{e}_i - \bar{\tilde{e}})^2$，其中$\tilde{e}_i$是用户$i$的聚合残差贡献（具体形式取决于模型）。这是最常用且稳健的方法。

    -   Booststrap（聚类Booststrap）：对用户进行重抽样（而不是对观测值），保持用户的所有数据完整。每次重抽样后计算$\hat{\tau}$，用多次（B次）重抽样得到的$\hat{\tau}^{(b)}$的方差来估计$\hat{\tau}$。计算量大但是灵活。

### 多重检验问题（Multiple Testing Problem）

-   问题核心：同时进行$K$次独立的假设检s验，每个检验的显著性水平都为$\alpha$。那么至少出现一次假阳性（I类错误）的概率（族系错误率FWER,Family-Wise Error Rate）是$$FWER = P(\text{至少一个错误拒绝} | \text{所有 } H₀ \text{ 为真}) = 1 - (1 - α)^K ≈ Kα \quad (\text{当 } α \text{ 很小时})$$，即使$\alpha = 0.05$，当$K$为10时，FWER约为0.4，假阳性率非常高。

-   ABTest中的来源：

    -   同时测试多个核心指标（$K>1$）

    -   同时测试多个变体（A/B/C/D...测试，$K>1$个比较）

    -   数据窥探（Peeking）：在实验运行期间多次查看结果并进行检验。每次查看都是一次独立的检验机会（$K$很大）。

-   控制方法（待补充）

### 进阶统计视角（待补充）

  AB测试的统计学原理深植于**因果推断**的潜在结果框架，**随机化**是其无偏估计的基石。**假设检验 (t/Z检验)**提供决策依据，**置信区间**量化不确定性。**功效分析**确保实验可靠性，**样本量计算**是实验设计的核心。实践中必须警惕**方差低估 (用户级相关性)** 和**多重检验膨胀**，采用聚类标准误或校正方法。贝叶斯方法和序贯检验提供了替代视角和效率提升。理解异质性效应能挖掘更深价值。掌握这些原理，是设计和解读可靠AB测试的关键。

## AB测试的流程与步骤

  ABtest其实就是控制变量法。为了评估测试和验证模型/项目的效果，在app/pc端设计出多个版本，在同一时间维度下，分别用组成相同/相似的群组去随机访问这些版本，记录下群组的用户体验数据和业务数据，最后评估不同方案的效果决定是否上线。

1.  **明确目标与假设**

-   定义清晰的业务目标（如提升注册转化率、增加平均订单价值）。

-   提出具体的、可证伪的统计假设（$H_0$和$H_1$）。

-   确定期望检测的最小有意义效应量MDE

2.  **确定目标指标与护栏指标**

-   **核心指标（Primary Metrics）：**直接反映实验目标的1-2个关键指标（如转化率、收入）
    -   例如：修改购买页面的主色调能够帮助用户购买率提升3%

    -   那么用户购买率就是我们关注的

    -   还需要关注一些新策略是否会对其他重要指标产生负面影响
-   **护栏指标（Guardrail Metrics）：**监控实验潜在负面影响的指标（如页面加载时间、关键功能使用率、崩溃率）。确保优化核心指标不以牺牲其他重要方面为代价。
    -   Organization Guardrail Metrics：新功能可能好但是加载慢；该付款界面UI对用户的下单单价不能有影响

    -   Trustworthy-related metrics：比如检查randomization，要用T-test或者卡方检验在查看A/B组的其他特征一致性
-   **探索性指标（Exploratory Metrics）**：帮助理解用户行为变化，发现意外结果的辅助指标。

3.  **实验设计**

-   单元选择（Unit of Diversion/randomization Unit）：决定随机化的最小单元（用户ID，设备ID，会话ID，页面访问）。选择时需要考虑指标计算（用户级指标需用户级分流）、用户多次体验（保持体验一致性）、样本独立性（避免干扰）。用户级分流最常见。

-   分流比例（Traffic Allocation）：分配多少样本去A/B组。通常是50:50，这样统计效率最高。但也会根据风险、流量大小调整（如90:10，新方案流量少）。需要确保样本量足够。

-   样本量计算（Sample Size Estimation）：
